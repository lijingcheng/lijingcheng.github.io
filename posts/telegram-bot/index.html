<!doctype html><html lang=zh-cn><head><title>Telegram 机器人程序开发 // 风行's Blog</title><meta charset=utf-8><meta name=generator content="Hugo 0.61.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="风行"><meta name=description content><link rel=stylesheet href=https://lijingcheng.github.io/css/main.min.61bb32028587f24ca28522d8d197970c7ef33284e5fffb45a75fcbbb2dbc4dcb.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Telegram 机器人程序开发"><meta name=twitter:description content="Telegram 是一款非常优秀的聊天软件，它非常重视用户隐私并对所有聊天信息进行加密并做永久存储，它还提供了种类丰富的群组和机器人，机器人是通过程序运作的账号，可以回复我们发送的消息，还可以提供消息的定时推送功能，例如推送新闻、天气预报、提醒事项等。
Telegram 官方为了让开发者能够参与到机器人的开发，还免费提供了功能齐全的 API，我们可以用它创建自己的机器人，下面介绍下如何创建和部署机器人程序。
准备工作 Telegram 支持多种语言来编写机器人，相对来说使用 Python 的比较多，并且有比较成熟的第三方库 python-telegram-bot 供选择使用，所以建议花点时间学习下 Python，掌握基本的开发方式和语法后就可以上手了，然后在开发过程中再去慢慢解决遇到的问题。
建议使用 PyCharm 作为 IDE 来编写程序，这样不仅可以在编写代码时有语法高亮和自动提示，而且还可以更方便的添加第三方库和包管理器，默认的包管理器是 pip，我们可以换成 pipenv，它会自动帮你管理虚拟环境和依赖文件。
下面列出几条 Python 语法中比较特别的地方
 代码缩进非常重要，同一代码块中的多行代码强制使用相同数量的空格，否则程序会编译不过 定义变量用 x = 5 就可以了，不用声明是常量还是变量，并且 x 作为 int 类型时，它的长度不受限制 python 中的字符串可以直接当数组来用，例： z = &lsquo;abcdefg&rsquo; z[0] = a, z[1:3] = bc if 语句中可使用 in 或 not in 关键字，例：if &lsquo;ab&rsquo; in &lsquo;abcd&rsquo; [&lsquo;a&rsquo;, &lsquo;b&rsquo;, &lsquo;c&rsquo;] 是 Array，(&lsquo;a&rsquo;, &lsquo;b&rsquo;, &lsquo;c&rsquo;) 是 Set 操作数组时索引可以是负数，表示从数组的后面开始按索引查找数据  创建机器人 在 Telegram 应用中通过与 @BotFather 交谈来创建自己的机器人，具体方式跟着引导来操作就可以了，需要注意的是每个机器人都会对应一个 Token，机器人的所有信息交互都会用到它，所以要保管好不要泄漏，避免其他人也能使用你的机器人做事情，创建机器人后可用链接 https://api."><meta property="og:title" content="Telegram 机器人程序开发"><meta property="og:description" content="Telegram 是一款非常优秀的聊天软件，它非常重视用户隐私并对所有聊天信息进行加密并做永久存储，它还提供了种类丰富的群组和机器人，机器人是通过程序运作的账号，可以回复我们发送的消息，还可以提供消息的定时推送功能，例如推送新闻、天气预报、提醒事项等。
Telegram 官方为了让开发者能够参与到机器人的开发，还免费提供了功能齐全的 API，我们可以用它创建自己的机器人，下面介绍下如何创建和部署机器人程序。
准备工作 Telegram 支持多种语言来编写机器人，相对来说使用 Python 的比较多，并且有比较成熟的第三方库 python-telegram-bot 供选择使用，所以建议花点时间学习下 Python，掌握基本的开发方式和语法后就可以上手了，然后在开发过程中再去慢慢解决遇到的问题。
建议使用 PyCharm 作为 IDE 来编写程序，这样不仅可以在编写代码时有语法高亮和自动提示，而且还可以更方便的添加第三方库和包管理器，默认的包管理器是 pip，我们可以换成 pipenv，它会自动帮你管理虚拟环境和依赖文件。
下面列出几条 Python 语法中比较特别的地方
 代码缩进非常重要，同一代码块中的多行代码强制使用相同数量的空格，否则程序会编译不过 定义变量用 x = 5 就可以了，不用声明是常量还是变量，并且 x 作为 int 类型时，它的长度不受限制 python 中的字符串可以直接当数组来用，例： z = &lsquo;abcdefg&rsquo; z[0] = a, z[1:3] = bc if 语句中可使用 in 或 not in 关键字，例：if &lsquo;ab&rsquo; in &lsquo;abcd&rsquo; [&lsquo;a&rsquo;, &lsquo;b&rsquo;, &lsquo;c&rsquo;] 是 Array，(&lsquo;a&rsquo;, &lsquo;b&rsquo;, &lsquo;c&rsquo;) 是 Set 操作数组时索引可以是负数，表示从数组的后面开始按索引查找数据  创建机器人 在 Telegram 应用中通过与 @BotFather 交谈来创建自己的机器人，具体方式跟着引导来操作就可以了，需要注意的是每个机器人都会对应一个 Token，机器人的所有信息交互都会用到它，所以要保管好不要泄漏，避免其他人也能使用你的机器人做事情，创建机器人后可用链接 https://api."><meta property="og:type" content="article"><meta property="og:url" content="https://lijingcheng.github.io/posts/telegram-bot/"><meta property="article:published_time" content="2020-03-20T18:19:12+08:00"><meta property="article:modified_time" content="2020-03-20T18:19:12+08:00"></head><body><header class=app-header><a href=https://lijingcheng.github.io><img class=app-header-avatar src=/images/avatar.png alt=风行></a><h1>风行's Blog</h1><p>一直在学习的大龄程序员</p><div class=app-header-social><a target=_blank href=https://github.com/lijingcheng rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a target=_blank href=https://www.instagram.com/bj_lijingcheng/ rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-instagram"><title>instagram</title><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Telegram 机器人程序开发</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Mar 20, 2020</div></div></header><div class=post-content><p>Telegram 是一款非常优秀的聊天软件，它非常重视用户隐私并对所有聊天信息进行加密并做永久存储，它还提供了种类丰富的群组和机器人，机器人是通过程序运作的账号，可以回复我们发送的消息，还可以提供消息的定时推送功能，例如推送新闻、天气预报、提醒事项等。</p><p>Telegram 官方为了让开发者能够参与到机器人的开发，还免费提供了功能齐全的 <a href=https://core.telegram.org/bots/api>API</a>，我们可以用它创建自己的机器人，下面介绍下如何创建和部署机器人程序。</p><h1 id=heading>准备工作</h1><p>Telegram 支持多种语言来编写机器人，相对来说使用 Python 的比较多，并且有比较成熟的第三方库 <a href=https://github.com/python-telegram-bot/python-telegram-bot>python-telegram-bot</a> 供选择使用，所以建议花点时间学习下 Python，掌握基本的开发方式和语法后就可以上手了，然后在开发过程中再去慢慢解决遇到的问题。</p><p>建议使用 PyCharm 作为 IDE 来编写程序，这样不仅可以在编写代码时有语法高亮和自动提示，而且还可以更方便的添加第三方库和包管理器，默认的包管理器是 pip，我们可以换成 pipenv，它会自动帮你管理虚拟环境和依赖文件。</p><p><img src=/images/pycharm_package.png alt></p><p>下面列出几条 Python 语法中比较特别的地方</p><ul><li>代码缩进非常重要，同一代码块中的多行代码强制使用相同数量的空格，否则程序会编译不过</li><li>定义变量用 x = 5 就可以了，不用声明是常量还是变量，并且 x 作为 int 类型时，它的长度不受限制</li><li>python 中的字符串可以直接当数组来用，例： z = &lsquo;abcdefg&rsquo; z[0] = a, z[1:3] = bc</li><li>if 语句中可使用 in 或 not in 关键字，例：if &lsquo;ab&rsquo; in &lsquo;abcd&rsquo;</li><li>[&lsquo;a&rsquo;, &lsquo;b&rsquo;, &lsquo;c&rsquo;] 是 Array，(&lsquo;a&rsquo;, &lsquo;b&rsquo;, &lsquo;c&rsquo;) 是 Set</li><li>操作数组时索引可以是负数，表示从数组的后面开始按索引查找数据</li></ul><h1 id=heading-1>创建机器人</h1><p>在 Telegram 应用中通过与 <a href=https://telegram.me/BotFather>@BotFather</a> 交谈来创建自己的机器人，具体方式跟着引导来操作就可以了，需要注意的是每个机器人都会对应一个 Token，机器人的所有信息交互都会用到它，所以要保管好不要泄漏，避免其他人也能使用你的机器人做事情，创建机器人后可用链接 <code>https://api.telegram.org/bot&lt;token>/getMe</code> 在浏览器里查看机器人信息，并能够看到以下反馈信息。</p><pre><code>{
    &quot;ok&quot;: true,
    &quot;result&quot;: {
        &quot;id&quot;: 985878205,
        &quot;is_bot&quot;: true,
        &quot;first_name&quot;: &quot;万达电影 iOS 团队&quot;,
        &quot;username&quot;: &quot;WandaFilm_Bot&quot;
    }
}
</code></pre><p>通过与 BotFather 交谈还能实现很多功能，详见以下图片内容</p><p><img src=/images/chat_with_botfather.png alt></p><h1 id=heading-2>举个例子</h1><p>下面这个简单例子可以使机器人能够响应 /start 和 /help 命令，还能够在收到聊天信息时进行回复，需要注意的是，如果你需要 VPN 才能够使用 Telegram，那么在机器人程序里你需要将 VPN 软件中的代理设置写在代码里。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> telegram.ext <span style=color:#f92672>import</span> Updater, CommandHandler, MessageHandler, Filters

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>start</span>(update, context):
    update<span style=color:#f92672>.</span>message<span style=color:#f92672>.</span>reply_text(<span style=color:#e6db74></span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>Hi!</span><span style=color:#e6db74>&#39;</span>)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>help</span>(update, context):
    update<span style=color:#f92672>.</span>message<span style=color:#f92672>.</span>reply_text(<span style=color:#e6db74></span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>Help!</span><span style=color:#e6db74>&#39;</span>)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>echo</span>(update, context):
    update<span style=color:#f92672>.</span>message<span style=color:#f92672>.</span>reply_text(update<span style=color:#f92672>.</span>message<span style=color:#f92672>.</span>text)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>error</span>(update, context):
    logger<span style=color:#f92672>.</span>warning(<span style=color:#e6db74></span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>Update </span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74> caused error </span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>&#39;</span>, update, context<span style=color:#f92672>.</span>error)

<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74></span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>__main__</span><span style=color:#e6db74>&#39;</span>:
    updater <span style=color:#f92672>=</span> Updater(<span style=color:#e6db74></span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>&lt;token&gt;</span><span style=color:#e6db74>&#39;</span>, use_context<span style=color:#f92672>=</span>True, request_kwargs<span style=color:#f92672>=</span>{
        <span style=color:#e6db74></span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>proxy_url</span><span style=color:#e6db74>&#39;</span>: <span style=color:#e6db74></span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>socks5://127.0.0.1:1086/</span><span style=color:#e6db74>&#39;</span>
    })

    dispatcher <span style=color:#f92672>=</span> updater<span style=color:#f92672>.</span>dispatcher

    dispatcher<span style=color:#f92672>.</span>add_handler(CommandHandler(<span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>start</span><span style=color:#e6db74>&#34;</span>, start))
    dispatcher<span style=color:#f92672>.</span>add_handler(CommandHandler(<span style=color:#e6db74></span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>help</span><span style=color:#e6db74>&#34;</span>, help))

    dispatcher<span style=color:#f92672>.</span>add_handler(MessageHandler(Filters<span style=color:#f92672>.</span>text, echo))

    dispatcher<span style=color:#f92672>.</span>add_error_handler(error)

    updater<span style=color:#f92672>.</span>start_polling()
    updater<span style=color:#f92672>.</span>idle()
</code></pre></div><p>想要了解机器人都能够做些什么事情，可以参考官方提供的 <a href=https://core.telegram.org/bots/api>API</a>，还可以参考 <code>python-telegram-bot</code> 提供的 <a href=https://python-telegram-bot.readthedocs.io/en/latest/index.html>文档</a> 和 <a href=https://github.com/python-telegram-bot/python-telegram-bot/wiki>Wiki</a>，最后就是发挥你的想象力了～</p><h1 id=heading-3>部署</h1><p>目前 Telegram 机器人支持两种获取用户消息的方法</p><ul><li><p>Long Polling：每隔一段时间通过 getUpdates 获取消息，缺点是会有延迟</p></li><li><p>Webhook：需要设置一个 HTTPS 协议的回调 URL，当有人给机器人发消息时，Telegram 会把消息发送到这个 URL 上，缺点是麻烦一些</p></li></ul><p>下面介绍在使用 Webhook 方式时，如何用最简单的方式将我们的机器人程序部署到 <a href=heroku.com>Heroku</a> 云平台所提供的回调地址上</p><ul><li><p>将机器人程序代码放到 GitHub 仓库中，注意不要暴露机器人的 Token，需要提交的仓库中的文件如下</p><ul><li>bot.py：编写机器人程序的代码文件</li><li>runtime.txt：描述所使用 python 语言版本的文件</li><li>requirements.txt：记录程序所使用第三方库的名称和版本号</li><li>Procfile：记录机器人程序代码所在的文件名</li></ul></li><li><p>在 Heroku 上注册账号并创建项目，然后再进行以下设置</p><ul><li>关联机器人程序所在的 GitHub 仓库和代码分支，目的是当你提交代码到该分支后能够自动部署</li><li>将一些如机器人 Token 这类的私密信息以环境变量的形式配置在 Heroku 提供的对应页面中，然后在代码中读取并使用，在本地开发调试程序时也需要将此类信息通过 PyCharm 配置到环境变量中</li></ul></li></ul><p><img src=/images/pycharm_var.png alt></p><p>完整的例子可以参考 <a href=https://github.com/lijingcheng/telegram-bot>https://github.com/lijingcheng/telegram-bot</a></p></div><div class=post-footer></div></article></main></body></html>